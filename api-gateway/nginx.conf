worker_processes auto;
events { worker_connections 1024; }

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile      on;
    keepalive_timeout 65;

    # ==============================================================================
    # DEFINICIÓN DE UPSTREAMS
    # ==============================================================================
    
    # Stock API (Node/NestJS) escucha en puerto 3000
    upstream stock_service {
        server stock-api:3000; 
    }

    # Logística API (.NET): Cambiamos a puerto 80 para corregir el error 502
    upstream logistica_service {
        server logistica-api:80; 
    }

    # Compras API (.NET) escucha en puerto 80
    upstream compras_service {
        server compras-api:81;
    }

    server {
        listen 80;
        server_name _;

        # CORS y Headers de Seguridad
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-Requested-With' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;

        # Manejo de Preflight (OPTIONS)
        if ($request_method = 'OPTIONS') {
            return 204;
        }

        # ----------------------------------------------------------
        # 1. RUTA PARA STOCK -> http://api.cubells.com.ar/stock/...
        # ----------------------------------------------------------
        location /stock/ {
            proxy_pass http://stock_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ----------------------------------------------------------
        # 2. RUTA PARA LOGÍSTICA -> http://api.cubells.com.ar/logistica/...
        # ----------------------------------------------------------
        location /logistica/ {
            proxy_pass http://logistica_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ----------------------------------------------------------
        # 3. RUTA PARA COMPRAS -> http://api.cubells.com.ar/compras/...
        # ----------------------------------------------------------
        location /compras/ {
            proxy_pass http://compras_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        # Default
        location / {
            return 404 "Ruta no encontrada. Use /stock/, /logistica/ o /compras/.";
        }
    }
}